#include <winsock2.h>
#include <stdio.h>

#include "Network.h"

unsigned char SmbNegociateSMB1[] =
"\x00\x00\x00\x85\xff\x53\x4d\x42\x72\x00\x00\x00\x00\x18\x53\xc0\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xfe\x00\x00\x40\x00"
"\x00\x62\x00\x02\x50\x43\x20\x4e\x45\x54\x57\x4f\x52\x4b\x20\x50\x52\x4f"
"\x47\x52\x41\x4d\x20\x31\x2e\x30\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x31\x2e"
"\x30\x00\x02\x57\x69\x6e\x64\x6f\x77\x73\x20\x66\x6f\x72\x20\x57\x6f\x72"
"\x6b\x67\x72\x6f\x75\x70\x73\x20\x33\x2e\x31\x61\x00\x02\x4c\x4d\x31\x2e"
"\x32\x58\x30\x30\x32\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x32\x2e\x31\x00\x02"
"\x4e\x54\x20\x4c\x4d\x20\x30\x2e\x31\x32\x00";

BOOL CheckSMBv1(char* ipAddress, int port){
    SOCKET sock = ConnectTcpServer(ipAddress, port);
    if (sock == INVALID_SOCKET)
        return FALSE;

    if (send(sock, (char*)SmbNegociateSMB1, sizeof(SmbNegociateSMB1) - 1, 0) != SOCKET_ERROR){
        char* recvbuff = (char*)malloc(1024);
        if (recvbuff == NULL)
            return FALSE;
        if (recv(sock, (char*)recvbuff, sizeof(recvbuff), 0) == SOCKET_ERROR){
            free(recvbuff);
            closesocket(sock);
            return FALSE;
        }

        free(recvbuff);
    }
    closesocket(sock);
    return TRUE;
}
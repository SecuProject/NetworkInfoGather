#include <winsock2.h>
#include <stdio.h>

#include "Network.h"
#include "XorRoutine.h"


unsigned char SmbNegociateSMB1Xor[] = {
        0x33,0x33,0xb2,0xce,0x60,0x7e,0x75,0x43,0x33,0x33,0x37,0x31,0x2b,0x60,0xf7,0x31,
        0x33,0x33,0x37,0x31,0x33,0x33,0x37,0x31,0x33,0x33,0x37,0x31,0x33,0xcc,0xc9,0x31,
        0x33,0x73,0x37,0x31,0x51,0x33,0x35,0x61,0x70,0x13,0x79,0x74,0x67,0x64,0x78,0x63,
        0x78,0x13,0x67,0x63,0x7c,0x74,0x65,0x70,0x7e,0x13,0x06,0x1f,0x03,0x33,0x35,0x7d,
        0x72,0x7d,0x7a,0x70,0x7d,0x02,0x19,0x01,0x33,0x31,0x60,0x58,0x5d,0x57,0x58,0x46,
        0x40,0x13,0x51,0x5e,0x41,0x13,0x60,0x5e,0x41,0x58,0x50,0x43,0x5c,0x46,0x47,0x42,
        0x13,0x00,0x19,0x00,0x52,0x33,0x35,0x7d,0x7e,0x02,0x19,0x03,0x6b,0x03,0x07,0x03,
        0x33,0x31,0x7b,0x70,0x7d,0x7e,0x76,0x7f,0x01,0x1d,0x06,0x31,0x31,0x7d,0x63,0x11,
        0x7f,0x7e,0x17,0x01,0x1d,0x02,0x05,0x31,0x33,0x00,
};

BOOL CheckSMBv1(char* ipAddress, int port){
    const char key[] = "1337";
    SOCKET sock = ConnectTcpServer(ipAddress, port);
    if (sock == INVALID_SOCKET)
        return FALSE;

    
    XorRoutine(SmbNegociateSMB1Xor, sizeof(SmbNegociateSMB1Xor), key);
    if (send(sock, (char*)SmbNegociateSMB1Xor, sizeof(SmbNegociateSMB1Xor) - 1, 0) != SOCKET_ERROR){
        char* recvbuff = (char*)malloc(1024);
        if (recvbuff == NULL)
            return FALSE;
        if (recv(sock, (char*)recvbuff, sizeof(recvbuff), 0) == SOCKET_ERROR){
            free(recvbuff);
            closesocket(sock);
            return FALSE;
        }

        free(recvbuff);
    }
    closesocket(sock);
    return TRUE;
}